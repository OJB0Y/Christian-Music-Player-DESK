const playlist = [
  {
    title: "Cordero",
    artist: "Manuel Bonilla",
    src: "songs/Cordero.mp3",
    cover: "images/song5.jpg"
  },
  {
    title: "Medley De Boleros - Elías Arriaza.mp3",
    artist: "Elías Arriaza",
    src: "songs/Medley De Boleros - Elías Arriaza.mp3",
    cover: "images/elias.png"
  },
  {
    title: "Como Una Flor (Versión Los Hermanos Reyes)",
    artist: "Hermanos Osorio, Los Hermanos Reyes de Guatemala",
    src: "songs/Como Una Flor (Versión Los Hermanos Reyes).mp3",
    cover: "images/Como Una Flor (Versión Los Hermanos Reyes).png"
  },
  {
    title: "Que lindo es mi Cristo",
    artist: "Hermanos Osorio, Los Hermanos Reyes de Guatemala",
    src: "songs/Que lindo es mi Cristo.mp3",
    cover: "images/Que lindo es mi Cristo.png"
  },
  {
    title: "Confía en el Señor (ft Francisco Orantes)",
    artist: "Hermanos Osorio, Francisco Orantes",
    src: "songs/Confía en el Señor - Hermanos Osorio.mp3",
    cover: "images/orantes.png"
  },
  {
    title: "A donde quiera que me lleves señor",
    artist: "Julio Elias",
    src: "songs/Julio Elias.mp3",
    cover: "images/Julio Elias.png"
  },
  {
    title: "Tengo Un Dios - Julio Elías",
    artist: "Julio Elias",
    src: "songs/Tengo Un Dios - Julio Elías.mp3",
    cover: "images/cover1.jpg"
  },
  {
    title: "Agradecimiento",
    artist: "Manuel Bonilla",
    src: "songs/Agradecimiento - Manuel Bonilla.mp3",
    cover: "images/manuel.png"
  },
  {
    title: "Buscale",
    artist: "Óscar Medina",
    src: "songs/Buscale.mp3",
    cover: "images/Buscale.jpg"
  },
  {
    title: "Te Estoy Esperando",
    artist: "Leonel Tuchez",
    src: "songs/Esperando.mp3",
    cover: "images/Esperando.jpg"
  },
  {
    title: "Todo el Mundo Busca",
    artist: "Wilson Camey",
    src: "songs/Todo el Mundo Busca - Wilson Camey.mp3",
    cover: "images/wc.png"
  },
  {
    title: "Tu Fidelidad",
    artist: "Marcos Witt/Alex Campos",
    src: "songs/a6.mp3",
    cover: "images/a6.png"
  },
  {
    title: "Oh Alma Mía",
    artist: "Los Voceros de Cristo",
    src: "songs/a5.mp3",
    cover: "images/a5.png"
  },
  {
    title: "Me Dicen Que Me Aman",
    artist: "Jesús Adrián Romero",
    src: "songs/a4.mp3",
    cover: "images/a4.png"
  },
  {
    title: "Renuévame",
    artist: "Marcos Witt",
    src: "songs/a2.mp3",
    cover: "images/a2.png"
  },
  {
    title: "Quien me podrá separar",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/a3.mp3",
    cover: "images/a3.png"
  },
  {
    title: "En Paz",
    artist: "Daniel Calveti",
    src: "songs/a1.mp3",
    cover: "images/a1.png"
  },
  {
    title: "Prometí aceptar tu palabra",
    artist: "Julio Elias",
    src: "songs/Prometí aceptar tu palabra.mp3",
    cover: "images/cover2.jpg"
  },
  {
    title: "Primero Dios, Vol. 5",
    artist: "Agustin Amador",
    src: "songs/Primero Dios, Vol. 5.mp3",
    cover: "images/cover3.jpg"   
  },
  {
    title: "Ahora Soy Feliz",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/song1.mp3",
    cover: "images/song1.jpg"
  },
  {
    title: "La Biblia",
    artist: "Manuel Bonilla",
    src: "songs/song2.mp3",
    cover: "images/song2.jpg"
  },
  {
    title: "Un Grano de Arena",
    artist: "Manuel Bonilla",
    src: "songs/Un Grano De Arena.mp3",
    cover: "images/Un Grano De Arena.png"
  },
  { 
    title: "Oh Juventud",
    artist: "Zulmy Mejia",
    src: "songs/Zulmy.mp3",
    cover: "images/zulmy.jpg"
  },
  {
    title: "Cristo por su Iglesia viene",
    artist: "Los Voceros de Cristo",
    src: "songs/Cristo.mp3",
    cover: "images/Cristo.jpg"
  },
  {
    title: "Loor a ti mi Dios",
    artist: "Los Voceros de Cristo",
    src: "songs/Loor.mp3",
    cover: "images/Loor.jpg"
  },
  {
    title: "Todos Deben de Saber/Conocer",
    artist: "Los Hermanos Reyes/Manuel Bonilla",
    src: "songs/song28.mp3",
    cover: "images/song28.png"
  },
  {
    title: "Esa Roca",
    artist: "Francisco Orantes",
    src: "songs/song3.mp3",
    cover: "images/song3.jpg"
  },
  {
    title: "El Amor de Dios",
    artist: "Manuel Bonilla",
    src: "songs/song4.mp3",
    cover: "images/song4.jpg"
  },
  {
    title: "En El Monte Cavalrio",
    artist: "Manuel Bonilla",
    src: "songs/song5.mp3",
    cover: "images/song5.jpg"
  },
  {
    title: "No Te Voy A Dejar",
    artist: "Leonel Tuchez",
    src: "songs/song6.mp3",
    cover: "images/song6.png"
  },
  {
    title: "Supe Que Me Amabas",
    artist: "Marcela Gandera",
    src: "songs/song7.mp3",
    cover: "images/song7.png"
  },
  {
    title: "A Quien Iremos",
    artist: "Los Hermanos Reyes",
    src: "songs/song8.mp3",
    cover: "images/song8.png"
  },
  {
    title: "Llegó el Amor",
    artist: "Aníbal Marroquin",
    src: "songs/song9.mp3",
    cover: "images/song9.png"
  },
  {
    title: "Confía En El Señor",
    artist: "Francisco Orantes",
    src: "songs/song10.mp3",
    cover: "images/song10.png"
  },
  {
    title: "Escogido fui de Dios",
    artist: "Los Voceros de Cristo",
    src: "songs/song11.mp3",
    cover: "images/song11.png"
  },
  {
    title: "Be Alright",
    artist: "Evan Craft",
    src: "songs/Be Alright.mp3",
    cover: "images/evan.png"
  },
  {
    title: "Más Rico Del Mundo",
    artist: "Evan Craft",
    src: "songs/Más_Rico_Del_Mundo.mp3",
    cover: "images/Más_Rico_Del_Mundo.png"
  },
  {
    title: "La Milla Extra",
    artist: "Evan Craft",
    src: "songs/La Milla Extra.mp3",
    cover: "images/La Milla Extra.png"
  },
  {
    title: "Desesperado",
    artist: "Evan Craft",
    src: "songs/Desesperado.mp3",
    cover: "images/evan.png"
  },
  {
    title: "Empezar de Nuevo",
    artist: "Kike Pavón/Funky",
    src: "songs/Empezar.mp3",
    cover: "images/kiki.png"
  },
  {
    title: "Vida Encontré",
    artist: "Majo y Dan",
    src: "songs/song13.mp3",
    cover: "images/song13.png"
  },
  {
    title: "Sueños",
    artist: "Un Corazón",
    src: "songs/song14.mp3",
    cover: "images/song14.png"
  },
  {
    title: "¿Cómo Podré Pagarte?",
    artist: "Leonel Tuchez",
    src: "songs/song15.mp3",
    cover: "images/song15.png"
  },
  {
    title: "Más Que Nunca feat. Danilo Montero (Versión Acústica)",
    artist: "Un Corazón",
    src: "songs/song16.mp3",
    cover: "images/song16.png"
  },
  {
    title: "Eres Todopoderoso",
    artist: "Rojo",
    src: "songs/song12.mp3",
    cover: "images/song12.png"
  },
  {
    title: "Tu Amor Hace Eco En Todo Mi Universo",
    artist: "Rojo",
    src: "songs/song17.mp3",
    cover: "images/song17.png"
  },
  {
    title: "Es Lo Que Quiero",
    artist: "Emmanuel y Linda",
    src: "songs/Es Lo Que Quiero.mp3",
    cover: "images/Es Lo Que Quiero.png"
  },
  {
    title: "Si No Fuera Por Ti",
    artist: "Rojo",
    src: "songs/Si No Fuera Por Ti.mp3",
    cover: "images/Si No Fuera Por Ti.png"
  },
  {
    title: "Yo Te Esperare",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Reyes.mp3",
    cover: "images/Hay una ciudad.png"
  },
  {
    title: "Has Cambiado mi lamento",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/lamento.mp3",
    cover: "images/lamento.jpg"
  },
  {
    title: "Te Doy Gracias",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/song27.mp3",
    cover: "images/song27.png"
  },
  {
    title: "Que Bueno es El Señor",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Que Bueno es El Señor.mp3",
    cover: "images/Que Bueno es El Señor.png"
  },
  {
    title: "He peleado la batalla",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/He peleado la batalla.mp3",
    cover: "images/He peleado la batalla.png"
  },
  {
    title: "Tengo un Dios",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Tengo un Dios.mp3",
    cover: "images/Tengo un Dios.png"
  },
  {
    title: "Hay un Dios",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Hay un Dios.mp3",
    cover: "images/Hay un Dios.png"
  },
  {
    title: "Hay una Ciudad",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Hay una ciudad.mp3",
    cover: "images/Hay una ciudad.png",
  },
  {
    title: "Alla en los Olivos",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Alla en los olivos.mp3",
    cover: "images/Hay una ciudad.png"
  },
  {
    title: "Como una Flor",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/song19.mp3",
    cover: "images/song19.png"
  },
  {
    title: "Como Una Flor - (EN VIVO)",
    artist: "Wilson Camey/Los Hermanos Reyes de Guatemala",
    src: "songs/Como Una Flor - En vivo - Wilson Camey.mp3",
    cover: "images/wilson.png"
  },
  {
    title: "Alto Precio - (EN VIVO)",
    artist: "Wilson Camey/Los Hermanos Reyes de Guatemala",
    src: "songs/Alto Precio - En vivo - Wilson Camey.mp3",
    cover: "images/wilson.png"
  },
  {
    title: "Alto Precio",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Alto Precio.mp3",
    cover: "images/song27.png"
  },
  {
    title: "Que Contento Estoy - (EN VIVO)",
    artist: "Wilson Camey/Los Hermanos Reyes de Guatemala",
    src: "songs/Que Contento Estoy - En vivo - Wilson Camey.mp3",
    cover: "images/wilson.png"
  },
  {
    title: "Contento Estoy",
    artist: "Los Hermanos Reyes de Guatemala",
    src: "songs/Contento Estoy.mp3",
    cover: "images/song27.png"
  },
  {
    title: "Todo Cambiará",
    artist: "Aníbal Marroquín",
    src: "songs/song20.mp3",
    cover: "images/song20.png"
  },
  {
    title: "Ríos De Agua Viva",
    artist: "Aníbal Marroquín",
    src: "songs/song21.mp3",
    cover: "images/song21.png"
  },
  {
    title: "Deja las Drogas",
    artist: "Aníbal Marroquín",
    src: "songs/song22.mp3",
    cover: "images/song22.png"
  },
  {
    title: "A Luchar Hermano",
    artist: "Aníbal Marroquín",
    src: "songs/song23.mp3",
    cover: "images/song23.png"
  },
  {
    title: "Josué 1: 8 Y 9",
    artist: "Leonel Tuchez",
    src: "songs/song24.mp3",
    cover: "images/song24.png"
  },
  {
    title: "Laberintos",
    artist: "La Feria Oficial/Majo y Dan",
    src: "songs/song25.mp3",
    cover: "images/song25.png"
  },
  {
    title: "El Secreto",
    artist: "Majo y Dan",
    src: "songs/song26.mp3",
    cover: "images/song26.png"
  }
];

// --- element refs ---
const audio = document.getElementById('audio');
const seekBar = document.getElementById('seek-bar');
const title = document.getElementById('title');
const artist = document.getElementById('artist');
const cover = document.getElementById('cover');
const playlistEl = document.getElementById('playlist');

const playBtn = document.getElementById('play');
const playIcon = document.getElementById('play-icon');
const nextBtn = document.getElementById('next');
const prevBtn = document.getElementById('prev');

const shuffleBtn = document.getElementById('shuffle');
const repeatBtn = document.getElementById('repeat');

const currentTimeEl = document.getElementById('current-time');
const durationEl = document.getElementById('total-duration');
const searchBar = document.getElementById('search-bar');


// --- state ---
let currentSong = 0;
let isPlaying = false;
let repeat = false;
let shuffle = false;

// shuffle queue + position
let shuffleQueue = [];
let shuffleIndex = -1;

// --- shuffle helpers ---
function createShuffleQueue(startIndex = currentSong) {
  shuffleQueue = Array.from({ length: playlist.length }, (_, i) => i);

  // Fisher–Yates shuffle
  for (let i = shuffleQueue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffleQueue[i], shuffleQueue[j]] = [shuffleQueue[j], shuffleQueue[i]];
  }

  // make sure currentSong is at the front, then start after it
  const pos = shuffleQueue.indexOf(startIndex);
  if (pos > -1) {
    [shuffleQueue[0], shuffleQueue[pos]] = [shuffleQueue[pos], shuffleQueue[0]];
  }
  shuffleIndex = 0;
}

function getNextShuffleSong() {
  if (shuffleIndex + 1 >= shuffleQueue.length) {
    createShuffleQueue(currentSong); // reshuffle when done
  }
  shuffleIndex++;
  return shuffleQueue[shuffleIndex];
}

function getPrevShuffleSong() {
  if (shuffleIndex > 0) {
    shuffleIndex--;
    return shuffleQueue[shuffleIndex];
  }
  return currentSong; // stay if no prev
}

// --- load & play ---
function loadSong(index) {
  const song = playlist[index];
  audio.src = song.src;
  title.textContent = song.title;
  artist.textContent = song.artist;
  cover.src = song.cover;
  updateActiveSong();
}

function playSong(index) {
  currentSong = index;
  loadSong(index);
  audio.play().catch(err => console.warn('Play prevented:', err));
}

function togglePlay() {
  if (isPlaying) {
    audio.pause();
  } else {
    audio.play();
  }
}

// --- build playlist UI/searchbar ---
function buildPlaylistUI(filterText = "") {
  playlistEl.innerHTML = "";
  const lowerFilter = filterText.toLowerCase();

  playlist.forEach((song, index) => {
    if (song.title.toLowerCase().includes(lowerFilter) || 
        song.artist.toLowerCase().includes(lowerFilter)) {
      const li = document.createElement('li');
      li.textContent = `${song.title} - ${song.artist}`;
      li.addEventListener('click', () => {
        playSong(index);
        if (shuffle) createShuffleQueue(index);
      });
      playlistEl.appendChild(li);
    }
  });

  updateActiveSong();
}

// build on load
buildPlaylistUI();

// hook up search
searchBar.addEventListener('input', () => {
  buildPlaylistUI(searchBar.value);
});

// --- update active playlist row ---
function updateActiveSong() {
  const items = document.querySelectorAll('#playlist li');
  items.forEach((item, i) => {
    item.classList.toggle('active', i === currentSong);
    if (i === currentSong) {
      //item.scrollIntoView({ behavior: 'smooth', block: 'center' });//
    }
  });
}

// --- time formatting ---
function formatTime(seconds) {
  if (!Number.isFinite(seconds)) return '0:00';
  const minutes = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
  return `${minutes}:${secs}`;
}

// --- audio events ---
audio.addEventListener('timeupdate', () => {
  seekBar.value = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
  currentTimeEl.textContent = formatTime(audio.currentTime);
  durationEl.textContent = `/ ${formatTime(audio.duration || 0)}`;
});

seekBar.addEventListener('input', () => {
  if (audio.duration) {
    audio.currentTime = (seekBar.value / 100) * audio.duration;
  }
});

audio.addEventListener('play', () => {
  setPlayIcon(true);
  isPlaying = true;
});

audio.addEventListener('pause', () => {
  setPlayIcon(false);
  isPlaying = false;
});

audio.addEventListener('ended', () => {
  if (repeat) {
    audio.currentTime = 0;
    audio.play();
    return;
  }
  if (shuffle) {
    currentSong = getNextShuffleSong();
    playSong(currentSong);
    return;
  }
  currentSong = (currentSong + 1) % playlist.length;
  playSong(currentSong);
});

// --- controls ---
playBtn.addEventListener('click', togglePlay);

nextBtn.addEventListener('click', () => {
  if (shuffle) {
    currentSong = getNextShuffleSong();
  } else {
    currentSong = (currentSong + 1) % playlist.length;
  }
  playSong(currentSong);
});

prevBtn.addEventListener('click', () => {
  if (shuffle) {
    currentSong = getPrevShuffleSong();
  } else {
    currentSong = (currentSong - 1 + playlist.length) % playlist.length;
  }
  playSong(currentSong);
});


// --- repeat & shuffle toggles ---
function setToggleButtonState(button, enabled) {
  if (enabled) {
    button.classList.add('mode-active');
    button.setAttribute('aria-pressed', 'true');
  } else {
    button.classList.remove('mode-active');
    button.setAttribute('aria-pressed', 'false');
  }
}

shuffleBtn.addEventListener('click', () => {
  shuffle = !shuffle;
  if (shuffle) {
    repeat = false;
    createShuffleQueue(currentSong);
  }
  setToggleButtonState(shuffleBtn, shuffle);
  setToggleButtonState(repeatBtn, repeat);
});

repeatBtn.addEventListener('click', () => {
  repeat = !repeat;
  if (repeat) shuffle = false;
  setToggleButtonState(repeatBtn, repeat);
  setToggleButtonState(shuffleBtn, shuffle);
});

// --- play/pause icon ---
function setPlayIcon(isNowPlaying) {
  playBtn.innerHTML = isNowPlaying
    ? `<svg viewBox="0 0 24 24" width="22" height="22"><rect x="6" y="5" width="4" height="14" fill="currentColor"></rect><rect x="14" y="5" width="4" height="14" fill="currentColor"></rect></svg>`
    : `<svg viewBox="0 0 24 24" width="22" height="22"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>`;
}

// --- init ---
currentSong = 0;
loadSong(currentSong);
updateActiveSong();
setPlayIcon(false);
